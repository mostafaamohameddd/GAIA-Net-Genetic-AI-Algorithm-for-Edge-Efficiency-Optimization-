{% extends "base.html" %}

{% block title %}Dashboard - IA Project{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-12">
        <h2><i class="fas fa-tachometer-alt"></i> Optimization Dashboard</h2>
        <p class="text-muted">Real-time performance metrics and visualizations</p>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card shadow h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted mb-2">Best Fitness</h6>
                        <h2 id="kpi-best" class="text-success">-</h2>
                    </div>
                    <i class="fas fa-trophy text-success opacity-25" style="font-size: 2rem;"></i>
                </div>
                <small class="text-muted">Peak optimization achieved</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card shadow h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted mb-2">Avg Fitness</h6>
                        <h2 id="kpi-avg" class="text-info">-</h2>
                    </div>
                    <i class="fas fa-chart-line text-info opacity-25" style="font-size: 2rem;"></i>
                </div>
                <small class="text-muted">Population average</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card shadow h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted mb-2">Generations</h6>
                        <h2 id="kpi-gens" class="text-warning">-</h2>
                    </div>
                    <i class="fas fa-history text-warning opacity-25" style="font-size: 2rem;"></i>
                </div>
                <small class="text-muted">Evolution cycles</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card shadow h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted mb-2">Total Evaluations</h6>
                        <h2 id="kpi-evals" class="text-danger">-</h2>
                    </div>
                    <i class="fas fa-calculator text-danger opacity-25" style="font-size: 2rem;"></i>
                </div>
                <small class="text-muted">Model evaluations</small>
            </div>
        </div>
    </div>
</div>

<!-- Visualizations Grid -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-images"></i> Optimization Visualizations</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshPlots()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Main Fitness Evolution Plot -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-area"></i> Fitness Evolution (Main)
                </h5>
            </div>
            <div class="card-body text-center">
                <img id="plot-evolution" src="" class="img-fluid" alt="Fitness Evolution"
                    style="max-height: 500px; display: none;">
                <p id="plot-evolution-loading" class="text-muted">Loading plot...</p>
            </div>
            <div class="card-footer">
                <a href="/api/plots/evolution_fitness" download class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download"></i> Download
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Secondary Plots Grid -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-bar-chart"></i> Statistics Summary</h5>
            </div>
            <div class="card-body text-center">
                <img id="plot-stats" src="" class="img-fluid" alt="Statistics Summary"
                    style="max-height: 350px; display: none;">
                <p id="plot-stats-loading" class="text-muted">Loading plot...</p>
            </div>
            <div class="card-footer">
                <a href="/api/plots/statistics_summary" download class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download"></i> Download
                </a>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-tachometer-alt"></i> Performance Analysis</h5>
            </div>
            <div class="card-body text-center">
                <img id="plot-perf" src="" class="img-fluid" alt="Performance Analysis"
                    style="max-height: 350px; display: none;">
                <p id="plot-perf-loading" class="text-muted">Loading plot...</p>
            </div>
            <div class="card-footer">
                <a href="/api/plots/performance_analysis" download class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download"></i> Download
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Convergence Diagnostics -->
<div class="row">
    <div class="col-lg-12">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-microscope"></i> Convergence Diagnostics</h5>
            </div>
            <div class="card-body text-center">
                <img id="plot-conv" src="" class="img-fluid" alt="Convergence Diagnostics"
                    style="max-height: 400px; display: none;">
                <p id="plot-conv-loading" class="text-muted">Loading plot...</p>
            </div>
            <div class="card-footer">
                <a href="/api/plots/convergence_diagnostics" download class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download"></i> Download
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    function loadMetrics() {
        fetch('/api/dashboard/summary')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const s = data.data;
                    document.getElementById('kpi-best').textContent = s.best_fitness.toFixed(4);
                    document.getElementById('kpi-avg').textContent = s.final_avg_fitness.toFixed(4);
                    document.getElementById('kpi-gens').textContent = s.total_generations;
                    document.getElementById('kpi-evals').textContent = s.total_evaluations;
                }
            })
            .catch(error => console.log('Error loading metrics'));
    }

    function loadPlots() {
        fetch('/api/plots')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.data && data.data.plots) {
                    const plots = [
                        { id: 'evolution_fitness', el: 'evolution' },
                        { id: 'statistics_summary', el: 'stats' },
                        { id: 'performance_analysis', el: 'perf' },
                        { id: 'convergence_diagnostics', el: 'conv' }
                    ];

                    plots.forEach(plot => {
                        if (data.data.plots[plot.id]) {
                            const img = document.getElementById(`plot-${plot.el}`);
                            const loading = document.getElementById(`plot-${plot.el}-loading`);

                            img.src = `/api/plots/${plot.id}?t=${Date.now()}`;
                            img.onload = function () {
                                img.style.display = 'block';
                                loading.style.display = 'none';
                            };
                            img.onerror = function () {
                                loading.textContent = 'Error loading plot';
                            };
                        }
                    });
                }
            })
            .catch(error => console.log('Error loading plots'));
    }

    function refreshPlots() {
        loadPlots();
        loadMetrics();
        showAlert('Dashboard refreshed!', 'success', 2000);
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadMetrics();
        loadPlots();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadMetrics();
        }, 30000);
    });
</script>

<style>
    .card-body {
        position: relative;
        min-height: 100px;
    }

    .text-success {
        color: #28a745 !important;
    }

    .text-info {
        color: #17a2b8 !important;
    }

    .text-warning {
        color: #ffc107 !important;
    }

    .text-danger {
        color: #dc3545 !important;
    }

    img.img-fluid {
        transition: all 0.3s ease;
    }

    img.img-fluid:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}